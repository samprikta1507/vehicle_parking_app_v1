{% extends "admin_layout.html" %}
{% block content %}
<div class="main-content">
            <!-- Content -->
            <div class="container mt-4">
                <div class="dashboard-title">Admin Dashboard</div>
                <div class="container mt-4">
                    <h2 class="mb-4">All Reservations</h2>
                        <table class="table table-bordered text-center">
                        <thead>
                            <tr>
                            <th>ID</th>
                            <th>User</th>
                            <th>Lot</th>
                            <th>Spot</th>
                            <th>Start</th>
                            <th>End</th>
                            <th>Cost</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in reservations %}
                            <tr>
                                <td>{{ r.id }}</td>
                                <td>{{ r.user.email }}</td>
                                <td>{{ r.parking_lot.name }}</td>
                                <td>{{ r.parking_spot.id }}</td>
                                <td>{{ r.park_time.strftime('%Y-%m-%d %H:%M') if r.park_time else 'N/A' }}</td>
                                <td>{{ r.release_time.strftime('%Y-%m-%d %H:%M') if r.release_time else 'N/A' }}</td>
                                <td>₹{{ r.cost }}</td>
                            </tr>


                            {% endfor %}
                        </tbody>
                        </table>
                </div>
                <div class="summary-subtitle">Summary shows statistical charts</div>

                    <!-- Charts -->
                <div class="chart-row">

                  <div class="chart-box">
                      <canvas id="summaryChart" width="400" height="250"></canvas>
                      <div class="chart-label">Reservations per Day</div>
                  </div>

                  <div class="chart-box">
                      <canvas id="revenueChart" width="400" height="250"></canvas>
                      <div class="chart-label">Revenue from each parking lot</div>
                  </div>

                  <div class="chart-box">
                      <canvas id="spotAvailabilityChart" width="400" height="250"></canvas>
                      <div class="chart-label">Parking Spot Overview</div>
                  </div>

              </div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Reservation Per Day Chart Script -->
<script>
fetch('/admin/summary/chart')
  .then(response => response.json())
  .then(data => {
    const labels = data.map(d => d.date);
    const counts = data.map(d => d.count);

    const ctx = document.getElementById('summaryChart').getContext('2d');
    new Chart(ctx, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'Reservations per Day',
          data: counts,
          fill: true,
          borderColor: 'rgba(75, 192, 192, 1)',
          backgroundColor: 'rgba(75, 192, 192, 0.2)',
          tension: 0.3
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Daily Reservation Count'
          }
        }
      }
    });
  });
</script>
<!-- Revenue Chart Script -->
<script>
fetch('/admin/revenue/chart')
  .then(response => response.json())
  .then(data => {
    const labels = data.map(d => d.lot);
    const revenue = data.map(d => d.revenue);

    const ctx = document.getElementById('revenueChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Revenue (₹)',
          data: revenue,
          backgroundColor: 'rgba(255, 99, 132, 0.6)',
          borderColor: 'rgba(255, 99, 132, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Revenue from Parking Lots'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Revenue (₹)'
            }
          }
        }
      }
    });
  });
</script>
<!-- Spot Availability Chart -->
<script>
fetch('/admin/spots/chart')
  .then(response => response.json())
  .then(data => {
    const ctx = document.getElementById('spotAvailabilityChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: ['Available Spots', 'Occupied Spots'],
        datasets: [{
          label: 'Spot Status',
          data: [data.available, data.occupied],
          backgroundColor: ['#28a745', '#dc3545'],
          borderColor: ['#ffffff', '#ffffff'],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        plugins: {
          legend: { position: 'bottom' },
          title: {
            display: true,
            text: 'Overall Parking Spot Availability'
          }
        }
      }
    });
  });
</script>

</div>
{% endblock %}