{% extends "user_layout.html" %}
{% block content %}
<div class="main-content">
<div class="container mt-4">
  <h2 class="mb-3">Reservation Summary for {{ user.full_name }}</h2>

  <table class="table table-bordered text-center">
    <thead class="table-light">
      <tr>
        <th>ID</th>
        <th>Parking Lot</th>
        <th>Spot</th>
        <th>Start Time</th>
        <th>End Time</th>
        <th>Duration (mins)</th>
        <th>Cost</th>
      </tr>
    </thead>
    <tbody>
      {% for r in history %}
      <tr>
        <td>{{ r.id }}</td>
        <td>{{ r.parking_lot.name }}</td>
        <td>{{ r.parking_spot.id }}</td>
        <td>{{ r.park_time.strftime('%Y-%m-%d %H:%M') if r.park_time else 'N/A' }}</td>
        <td>{{ r.release_time.strftime('%Y-%m-%d %H:%M') if r.release_time else 'N/A' }}</td>
        <td>
          {% if r.park_time and r.release_time %}
            {{ ((r.release_time - r.park_time).total_seconds() // 60)|int }}
          {% else %}
            N/A
          {% endif %}
        </td>
        <td>₹{{ r.cost }}</td>
      </tr>
      {% else %}
      <tr>
        <td colspan="7">No parking history found</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>
<div class="mt-3 fw-bold">
  Total Duration: {{ total_minutes }} minutes
  <br>
  Total Cost: ₹{{ total_cost }}
</div>

<!-- Chart Container -->
<div class="chart-row">
  <div class="chart-box">
    <canvas id="usageChart" width="400" height="250"></canvas>
    <div class="chart-label">Parking Duration Over Time</div>
  </div>

  <div class="chart-box">
    <canvas id="spotUsageChart" width="400" height="250"></canvas>
    <div class="chart-label">Summary on already used parking spots</div>
  </div>
</div>

<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Chart Script -->
<script>
fetch('/user/history/chart')
  .then(response => response.json())
  .then(data => {
    const labels = data.map(d => d.date);
    const durations = data.map(d => d.duration);

    const ctx = document.getElementById('usageChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Duration (minutes)',
          data: durations,
          backgroundColor: 'rgba(153, 102, 255, 0.6)',
          borderColor: 'rgba(153, 102, 255, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Parking Duration per Reservation'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Duration (minutes)'
            }
          }
        }
      }
    });
  });
</script>
<!-- Spot Usage Chart Script -->
<script>
fetch('/user/spot-usage/chart')
  .then(response => response.json())
  .then(data => {
    const labels = data.map(d => d.spot);
    const counts = data.map(d => d.count);

    const ctx = document.getElementById('spotUsageChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Number of Times Used',
          data: counts,
          backgroundColor: 'rgba(75, 192, 192, 0.6)',
          borderColor: 'rgba(75, 192, 192, 1)',
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        plugins: {
          title: {
            display: true,
            text: 'Usage Count Per Spot'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: 'Times Used'
            }
          }
        }
      }
    });
  });
</script>
</div>
{% endblock %}
